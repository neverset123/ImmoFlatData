name: ImmoAgent Workflow

on:
  workflow_dispatch: # Trigger manually

jobs:
  rate_limited_job:
    runs-on: ubuntu-latest
    steps:
      - name: Get Last Successful Run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LAST_RUN=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/neverset123/ImmoFlatData/actions/workflows/Agent_trigger.yaml/runs?status=success&per_page=1" \
            | jq -r '.workflow_runs[0].created_at')
          echo "Last successful run was at: $LAST_RUN"
      - name: Check Time Difference
        run: |
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          LAST_RUN_SECONDS=$(date -d "$LAST_RUN" +%s)
          NOW_SECONDS=$(date -d "$NOW" +%s)
          DIFF=$((NOW_SECONDS - LAST_RUN_SECONDS))
          if [ "$DIFF" -lt 300 ]; then
            echo "Rate limit not reached. Exiting."
            exit 0
          fi
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r script/requirements.txt
      - name: publish data
        env:
          PYTHONPATH: ${{ github.workspace }}
          ENDPOINT: ${{ secrets.ENDPOINT }} 
          APIKEY: ${{ secrets.APIKEY }} 
          CHAT_MODEL: ${{ secrets.CHAT_MODEL }} 
          EMBEDDING_MODEL: ${{ secrets.EMBEDDING_MODEL }} 
          API_VERSION: ${{ secrets.API_VERSION }} 
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }} 
          HOME_PAGE_ID: ${{ secrets.HOME_PAGE_ID }} 
          DB_PREFERENCE_ID: ${{ secrets.DB_PREFERENCE_ID }} 
          DB_PROPERTY_ID: ${{ secrets.DB_PROPERTY_ID }} 
          DB_PROPERTY_PAGE_URL: ${{ secrets.DB_PROPERTY_PAGE_URL }} 
        run: |
          python script/embedder.py
          python script/publisher.py